<!DOCTYPE HTML>
<html>
<head>
	<meta http-equiv="content-type" content="text/html" />
	<meta name="author" content="" />
 <metaÂ name="viewport"content="width=device-width, initial-scale=1.0"> 
	<title>Tetrix</title>
</head>


<body>

</body>
<script type="text/javascript">
var tetrix = function(){
    this.state = 0; // 0: welcome, 1: play, 2: pause
    this.score = 0;
    this.speed = 1;
    this.canvas = null;
    this.ctx = null;
    this.numCols = 10;
    this.numRows = 20;
    this.width = 100;
    this.height = 200;
    this.board = [[]];
    this.shapes = [
                    [
                        [1,1,1,1]
                    ],
                    [
                        [1,1,1],
                        [0,1,0]
                    ],
                    [
                        [1,1],
                        [1,1]
                    ],
                    [
                        [1,1],
                        [1,0],
                        [1,0]
                    ],
                    [
                        [1,1],
                        [0,1],
                        [0,1]
                    ],
                    [
                        [1,1,0],
                        [0,1,1]
                    ],
                    [
                        [0,1,1],
                        [1,1,0]
                    ]
                 ];
    this.currentShape = [[]];
    
    this.currentShapeRow = 0;
    this.currentShapeCol = 2;
    
    this.init = function(){
        this.createBoard();
        this.canvas = document.createElement('canvas');
        this.ctx = this.canvas.getContext('2d');
        this.canvas.width = 150;
        this.canvas.height = 250;
        this.createNewShape();
        document.body.appendChild(this.canvas);
    }
    
    // tao du lieu cho board
    this.createBoard = function(){
        for (var row = 0; row < this.numRows + 4; row++){
            this.board[row] = [];
            for (col = 0; col < this.numCols; col++){
                this.board[row][col] = 0;
            }
        }
    }
    
    this.drawNoDot = function(row, col){
        this.ctx.fillStyle = '#ff0000';
        var dotSize = this.width / this.numCols - 2;
        var x = col * (dotSize + 1);
        var y = row * (dotSize + 1);
        this.ctx.fillRect(x, y, dotSize, dotSize);
    }
    
    this.drawDot = function(row, col){
        this.ctx.fillStyle = '#000000';
        var dotSize = this.width / this.numCols - 2;
        var x = col * (dotSize + 1);
        var y = row * (dotSize + 1);
        this.ctx.fillRect(x, y, dotSize, dotSize);
    }
    
    this.shapeFall = function(){
        if (this.shapeCanMoveDown()){
            this.currentShapeRow += 1;
        }
        else {
            this.appendShapeToBoard();
            this.checkCompleteLine();
            this.createNewShape();
        }
    }
    
    this.shapeCanMoveDown = function(){
        if (this.shapeToBottom()){
            return false;
        }
        for (var row = 0; row < this.currentShape.length; row++){            
            for (col = 0; col < this.currentShape[row].length; col++){   
                if (this.currentShape[row][col] == 1){
                    if (this.board[this.currentShapeRow + row + 1][this.currentShapeCol + col] == 1){
                        return false;
                    }
                }
            }
        }
        return true;
    }
    
    this.shapeToBottom = function(){
        if (this.currentShapeRow + this.currentShape.length - 1 == this.board.length - 1){
            return true;
        }
        return false;
    }
    
    this.shapeCanMoveLeft = function(){
        if (this.shapeToLeft()){
            return false;
        }
        for (var row = 0; row < this.currentShape.length; row++){            
            for (col = 0; col < this.currentShape[row].length; col++){   
                if (this.currentShape[row][col] == 1){
                    if (this.board[this.currentShapeRow + row][this.currentShapeCol + col - 1] == 1){
                        return false;
                    }
                }
            }
        }
        return true;
    }
    
    this.shapeToLeft = function(){
        if (this.currentShapeCol == 0){
            return true;
        }
        return false;
    }
    
    this.shapeCanMoveRight = function(){
        if (this.shapeToRight()){
            return false;
        }
        for (var row = 0; row < this.currentShape.length; row++){            
            for (col = 0; col < this.currentShape[row].length; col++){   
                if (this.currentShape[row][col] == 1){
                    if (this.board[this.currentShapeRow + row][this.currentShapeCol + col + 1] == 1){
                        return false;
                    }
                }
            }
        }
        return true;
    }
    
    this.shapeToRight = function(){
        if (this.currentShapeCol + this.currentShape[0].length - 1 == this.numCols - 1){
            return true;
        }
        return false;
    }
    
    
    this.createNewShape = function(){
        this.currentShapeRow = 0;
        var randomNum = Math.floor(Math.random() * this.shapes.length);
        this.currentShape = this.shapes[randomNum];
    }
    
    this.drawBoard = function(){
        for (var row = 3; row < this.board.length; row++){
            for (col = 0; col < this.board[row].length; col++){
                if (this.board[row][col] == 1){
                    
                    this.drawDot(row, col);
                }
                else {
                    this.drawNoDot(row, col);
                }
            }
        }
        
    }
    
    this.appendShapeToBoard = function(){
        for (var row = 0; row < this.currentShape.length; row++){            
            for (col = 0; col < this.currentShape[row].length; col++){               
                if (this.currentShape[row][col] == 1){
                    this.board[this.currentShapeRow + row][this.currentShapeCol + col] = 1;
                }
            }
        }
    }
    
    this.drawShape = function(){
        if (this.currentShapeRow + this.currentShape.length > 4){
            for (var row = 0; row < this.currentShape.length; row++){            
                for (col = 0; col < this.currentShape[row].length; col++){               
                    if (this.currentShape[row][col] == 1){
                        this.drawDot(this.currentShapeRow + row, this.currentShapeCol + col);
                    }
                }
            }
        }
    }
    
    this.removeACompleteLine = function(lineNumber){
        for (i = lineNumber; i > 0; i--){
            this.board[i] = this.board[i - 1];
        }
    }
    
    this.isCompleteLine = function(lineNumber){
        var complete = true;
        for (var i = 0; i < this.numCols; i++){
            if (this.board[lineNumber][i] == 0){
                complete = false;
            }
        }
        return complete;
    }
    
    this.checkCompleteLine = function(){
        for (var i = 0; i < this.board.length; i++){
            if (this.isCompleteLine(i)){
                this.removeACompleteLine(i);
            }
        }
    }
    
    this.rotate = function(){
        var newShape = [[]];

        for (var i = 0; i < this.currentShape[0].length; i++){
            newShape[i] = [];
            var k = 0;
            for (var j = this.currentShape.length - 1; j >= 0; j--){
                newShape[i][k] = this.currentShape[j][i];
                k += 1;
            }
        }
        this.currentShape = newShape;
    }
    
    this.rotatedShapeValid = function(rotatedShape){
        
    }
    
    this.render = function(){
        this.drawBoard();        
        this.drawShape();
    }
    
    this.update = function(){        
        this.shapeFall();
    }
    
    this.moveLeft = function(){
        if (this.shapeCanMoveLeft()){
            this.currentShapeCol -= 1;
        }
    }
    this.moveRight = function(){
        if (this.shapeCanMoveRight()){
            this.currentShapeCol += 1;
        }
    }
}

var game = new tetrix();
game.init();
function loop(){
    game.update();
    game.render();
    setTimeout(loop, 300);
}

function nextStep(){
    loop();
}
function moveLeft(){
    game.moveLeft();
}
function moveRight(){
    game.moveRight();
}
function rotate(){
    game.rotate();
}
</script>
<br />
<button onclick="nextStep();">next step</button>
<button onclick="moveLeft();">trai</button>
<button onclick="moveRight();">phai</button>
<button onclick="rotate();">xoay</button>
</html>
